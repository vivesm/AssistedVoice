<!DOCTYPE html>
<html>

<head>
    <title>Audio Capture Test</title>
    <style>
        body {
            font-family: Arial;
            padding: 40px;
            background: #1a1a2e;
            color: white;
        }

        button {
            padding: 20px 40px;
            margin: 10px;
            font-size: 18px;
            cursor: pointer;
            border-radius: 8px;
        }

        #recordBtn {
            background: #e74c3c;
            color: white;
            border: none;
        }

        #recordBtn.recording {
            background: #27ae60;
        }

        #playBtn {
            background: #3498db;
            color: white;
            border: none;
        }

        #sendBtn {
            background: #9b59b6;
            color: white;
            border: none;
        }

        #status {
            margin: 20px 0;
            padding: 20px;
            background: #16213e;
            border-radius: 8px;
        }

        #result {
            margin: 20px 0;
            padding: 20px;
            background: #0f3460;
            border-radius: 8px;
            min-height: 100px;
        }

        .success {
            color: #2ecc71;
        }

        .error {
            color: #e74c3c;
        }

        audio {
            width: 100%;
            margin: 20px 0;
        }
    </style>
</head>

<body>
    <h1>üé§ Audio Capture Diagnostic Test</h1>

    <div id="status">Click "Start Recording" and speak clearly</div>

    <button id="recordBtn" onclick="toggleRecording()">Start Recording</button>
    <button id="playBtn" onclick="playRecording()" disabled>Play Recording</button>
    <button id="sendBtn" onclick="sendToServer()" disabled>Send to Server for Transcription</button>

    <audio id="audioPlayer" controls style="display:none;"></audio>

    <div id="result">
        <strong>Test Results:</strong><br>
        <span id="blobSize">Blob size: --</span><br>
        <span id="duration">Duration: --</span><br>
        <span id="transcription">Transcription: --</span>
    </div>

    <h2>Instructions:</h2>
    <ol>
        <li>Click "Start Recording" and say "one two three four five" clearly</li>
        <li>Click "Stop Recording"</li>
        <li>Click "Play Recording" - can you hear yourself?</li>
        <li>Click "Send to Server" to test transcription</li>
    </ol>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let mediaRecorder = null;
        let audioChunks = [];
        let audioBlob = null;
        let isRecording = false;
        let startTime = null;

        const socket = io();

        socket.on('transcription', (data) => {
            document.getElementById('transcription').innerHTML =
                `<span class="success">Transcription: "${data.text}"</span>`;
            document.getElementById('status').innerHTML = 'Transcription received!';
        });

        socket.on('error', (data) => {
            document.getElementById('transcription').innerHTML =
                `<span class="error">Error: ${data.message}</span>`;
        });

        async function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                await startRecording();
            }
        }

        async function startRecording() {
            try {
                audioChunks = [];

                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });

                // Log all available audio tracks
                const tracks = stream.getAudioTracks();
                console.log('Audio tracks:', tracks);
                console.log('Track settings:', tracks[0].getSettings());

                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
                        ? 'audio/webm;codecs=opus'
                        : 'audio/webm'
                });

                console.log('MediaRecorder mimeType:', mediaRecorder.mimeType);

                mediaRecorder.ondataavailable = (event) => {
                    console.log('Chunk received:', event.data.size, 'bytes');
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
                    const duration = ((Date.now() - startTime) / 1000).toFixed(1);

                    document.getElementById('blobSize').innerHTML =
                        `Blob size: <strong>${audioBlob.size} bytes</strong> (should be >10000 for speech)`;
                    document.getElementById('duration').innerHTML =
                        `Duration: <strong>${duration}s</strong>`;

                    if (audioBlob.size < 5000) {
                        document.getElementById('blobSize').innerHTML +=
                            ' <span class="error">‚ö†Ô∏è TOO SMALL - browser not capturing audio!</span>';
                    } else {
                        document.getElementById('blobSize').innerHTML +=
                            ' <span class="success">‚úì Good size</span>';
                    }

                    // Create playback URL
                    const audioUrl = URL.createObjectURL(audioBlob);
                    document.getElementById('audioPlayer').src = audioUrl;
                    document.getElementById('audioPlayer').style.display = 'block';

                    document.getElementById('playBtn').disabled = false;
                    document.getElementById('sendBtn').disabled = false;

                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());
                };

                startTime = Date.now();
                mediaRecorder.start(100); // 100ms chunks
                isRecording = true;

                document.getElementById('recordBtn').textContent = 'Stop Recording';
                document.getElementById('recordBtn').classList.add('recording');
                document.getElementById('status').innerHTML = 'üî¥ Recording... Speak now!';

            } catch (err) {
                console.error('Error:', err);
                document.getElementById('status').innerHTML =
                    `<span class="error">Error: ${err.message}</span>`;
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
            isRecording = false;
            document.getElementById('recordBtn').textContent = 'Start Recording';
            document.getElementById('recordBtn').classList.remove('recording');
            document.getElementById('status').innerHTML = 'Recording stopped. Click Play to hear it.';
        }

        function playRecording() {
            const player = document.getElementById('audioPlayer');
            player.play();
            document.getElementById('status').innerHTML = 'Playing back your recording...';
        }

        function sendToServer() {
            if (!audioBlob) {
                alert('No recording available');
                return;
            }

            document.getElementById('status').innerHTML = 'Sending to server...';
            document.getElementById('transcription').innerHTML = 'Transcription: Processing...';

            const reader = new FileReader();
            reader.onloadend = () => {
                socket.emit('process_audio', {
                    audio: reader.result,
                    enable_tts: false
                });
            };
            reader.readAsDataURL(audioBlob);
        }
    </script>
</body>

</html>